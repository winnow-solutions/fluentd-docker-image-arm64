<system>
  log_level error
</system>

<source>
  @type systemd
  tag logs.*
  path /run/log/journal
  matches [{ "_SYSTEMD_UNIT": "balena.service" }]
</source>

<filter>
  @type systemd_entry
  field_map {"MESSAGE": "log", "CONTAINER_NAME": "container_name"}
  field_map_strict true
  fields_lowercase true
  fields_strip_underscores false
</filter>

# Convert a log field to json
<filter>
  @type docker
</filter>

<match> # This is matching everything
   @type mqtt
   host "#{ENV['MQTT_SERVER']}"
   port "#{ENV['MQTT_PORT']}"
   client_id "#{ENV['MQTT_CLIENT_ID']}"
   <security>
     username "#{ENV['MQTT_USERNAME']}"
     password "#{ENV['MQTT_PASSWORD']}"
   </security>
   topic_rewrite_pattern '^.*$'
   topic_rewrite_replacement "#{ENV['MQTT_TOPIC']}"
   <format>
     @type json
   </format>
   <inject>
     time_key @log_time
     time_type unixtime
    </inject>
</match>
